# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#matlab_add_mex(NAME cuphy_mex OUTPUT_NAME cuphy_mex SRC cuphy_mex.c c_mexapi_version.c)
# CMake matlab_add_mex() command doesn't seem to work with R2018b. See:
# https://gitlab.kitware.com/cmake/cmake/issues/18391
# https://www.mathworks.com/matlabcentral/answers/377799-compiling-mex-files-without-the-mex-command
# (Attempting to use the generated MEX library from within MATLAB results in
# an error message about a missing gateway function. The command 'objdump -T
# lib.mexa64' in fact shows that the libraries generated by the MATLAB mex
# script have an export defined for mexFunction, whereas CMake generated
# libraries do not.) 
# Instead we will generate a library and manually specify the options shown
# in the Makefile link above from Mathworks.

# Matrix APIs:
# -DMX_COMPAT_32: compatibleArrayDims
# -DMATLAB_DEFAULT_RELEASE=R2017b: largeArrayDims
# -DMATLAB_DEFAULT_RELEASE=R2018a: Interleaved Complex
# MATLABMEX += -DMX_COMPAT_32

add_library(cuphy_mex SHARED cuphy_mex.cpp)
target_include_directories(cuphy_mex PUBLIC ${Matlab_ROOT_DIR}/extern/include)
target_link_libraries(cuphy_mex cuphy_hdf5 cuphy)
set_target_properties(cuphy_mex PROPERTIES PREFIX "")
set_target_properties(cuphy_mex PROPERTIES SUFFIX .${Matlab_MEX_EXTENSION})
set_target_properties(cuphy_mex PROPERTIES COMPILE_DEFINITIONS "MATLAB_MEX_FILE;MX_COMPAT_32")

