# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Set name of excutable 
set(TARGET cubb_gpu_test_bench)

# cuMAC compilation option (default enabled)
option(ENABLE_CUMAC "Enable cuMAC support in cuBB GPU test bench" ON)

# set sources
set(CUPHY_EXAMPLE_DIR ../../cuPHY/examples)
set(CUMAC_DIR ../../cuMAC)

set(SOURCES ${CUPHY_EXAMPLE_DIR}/common/util.cu ${CUPHY_EXAMPLE_DIR}/pusch_rx_multi_pipe/pusch_rx_test.cpp testbench_common.cpp cuphy_testWrkr.cpp cubb_gpu_test_bench.cpp ${CUPHY_EXAMPLE_DIR}/common/datasets.cpp)

# Conditionally add cuMAC sources and set compile definition
if(ENABLE_CUMAC)
    add_compile_definitions(AERIAL_CUMAC_ENABLE)
    set(SOURCES ${SOURCES} cumac_testWrkr.cpp)
endif()

# add executable
add_executable(${TARGET} ${SOURCES})

# set include directories
if(ENABLE_CUMAC)
    target_include_directories(${TARGET} PRIVATE ${CUPHY_EXAMPLE_DIR}/pusch_rx_multi_pipe ${CUPHY_EXAMPLE_DIR}/pdsch_tx ${CUPHY_EXAMPLE_DIR}/common ${CUMAC_DIR}/src ${HDF5_CXX_INCLUDE_DIRS} ${CUMAC_DIR}/examples/tvLoadingTest)
    # set libraries with cuMAC                                           
    target_link_libraries(${TARGET} PRIVATE cuphy_channels cuphy_hdf5 cuphy Threads::Threads yaml cumac ${HDF5_CXX_LIBRARIES})
else()
    target_include_directories(${TARGET} PRIVATE ${CUPHY_EXAMPLE_DIR}/pusch_rx_multi_pipe ${CUPHY_EXAMPLE_DIR}/pdsch_tx ${CUPHY_EXAMPLE_DIR}/common ${HDF5_CXX_INCLUDE_DIRS})
    # set libraries without cuMAC
    target_link_libraries(${TARGET} PRIVATE cuphy_channels cuphy_hdf5 cuphy Threads::Threads yaml ${HDF5_CXX_LIBRARIES})
endif()
target_include_directories(${TARGET} PUBLIC $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}> ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES})