% SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
% SPDX-License-Identifier: Apache-2.0
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
% http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.

function SimCtrl = init_table_ML_datasets(SimCtrl)
    % set Python version
    try 
        pyenv(Version=SimCtrl.ml.python_executable, ExecutionMode=SimCtrl.ml.python_ExecutionMode);
    catch
        terminate(pyenv)
        pyenv(Version=SimCtrl.ml.python_executable, ExecutionMode=SimCtrl.ml.python_ExecutionMode);
    end
    display(pyenv)
%     if (pe.Status == 'Loaded')  
%         if (~strcmp(pe.Executable, SimCtrl.ml.python_executable))
%             if strcmp(pe.ExecutionMode, SimCtrl.ml.python_ExecutionMode)
%                 terminate(pyenv);
%                 pyenv(Version=SimCtrl.ml.python_executable, ExecutionMode=SimCtrl.ml.python_ExecutionMode);
%             else
%                 error('Python was already loaded with a different executable and it is InProcess ExecutionMode. Restart MATLAB to load your preferred version and set ExecutionMode to OutOfProcess!')
%             end
%         end
%     else
%         pyenv(Version=SimCtrl.ml.python_executable, ExecutionMode=SimCtrl.ml.python_ExecutionMode);
%     end
    py.importlib.import_module('pandas'); % works with pandas1.3.5, pyarrow4.0.0/5.0.0/6.0.0/7.0.0/8.0.0 (pip install pyarrow==4.0.0)
    py.importlib.import_module('numpy');
    if SimCtrl.ml.dataset.channel == 'pusch'
        % variables following FAPI, and referring to MLDP in aerial_pkg/src/aerial/mldp/pusch.py
        SimCtrl.ml.dataset.table_ML_datasets = py.pandas.DataFrame(pyargs('columns', py.list( {...
              'timestamp',                  ...
              'pduIdx',                     ...
              'SFN',                        ...
              'Slot',                       ...
              'nPDUs',                      ...
              'RachPresent',                ...
              'nULSCH',                     ...
              'nULCCH',                     ...
              'nGroup',                     ...
              'PDUSize',                    ...
              'pduBitmap',                  ...
              'RNTI',                       ...
              'Handle',                     ...
              'BWPSize',                    ...
              'BWPStart',                   ...
              'SubcarrierSpacing',          ...
              'CyclicPrefix',               ...
              'targetCodeRate',             ...
              'qamModOrder',                ...
              'mcsIndex',                   ...
              'mcsTable',                   ...
              'TransformPrecoding',         ...
              'dataScramblingId',           ...
              'nrOfLayers',                 ...
              'DmrsSymbPos',                ...
              'dmrsConfigType',             ...
              'ulDmrsScramblingId',         ...
              'puschIdentity',              ...
              'SCID',                       ...
              'numDmrsCdmGrpsNoData',       ...
              'dmrsPorts',                  ...
              'resourceAlloc',              ...
              'rbBitmap',                   ...
              'rbStart',                    ...
              'rbSize',                     ...
              'VRBtoPRBMapping',            ...
              'FrequencyHopping',           ...
              'txDirectCurrentLocation',    ...
              'uplinkFrequencyShift7p5khz', ...
              'StartSymbolIndex',           ...
              'NrOfSymbols',                ...
              'nUE_inUeg',                  ...
              'idxUE',                      ...
              'idxUeg',                     ...
              'puschData',                  ... % Need to revisit
              'puschUci',                   ...
              'puschPtrs',                  ...
              'dftsOfdm',                   ...
              'Beamforming',                ...
              'HarqID',                     ...
              'PDULen',                     ...
              'UL_CQI',                     ...
              'TimingAdvance',              ...
              'RSSI',                       ...
              'macPdu',                     ... % Need to revist
              'TbCrcStatus',                ...
              'NumCb',                      ...
              'CbCrcStatus',                ...
              'channel_model_type',         ...
              'channel_model_SNR',          ...
              'interf_channel_model_SIR',   ...
              'gt_coded_rm_bit_payload',    ...
              'gt_data_symbols_i',          ...
              'gt_data_symbols_q',          ...
              'gt_Xtf_i',                   ...
              'gt_Xtf_q',                   ...
              'gt_Xtf_shape',               ...
              'Ytf_i',                      ...
              'Ytf_q',                      ...
              'Ytf_shape',                  ...
              'chan_est_i',                 ...
              'chan_est_q',                 ...
              'chan_est_shape',             ...
              'errInd',                     ...
              'gt_info_bit_payload',        ...
              'gt_channel_i',               ...
              'gt_channel_q',               ...
              'gt_channel_shape',           ...
              'gt_time_offset',             ...
              'gt_freq_offset'              ...
              })));

        for idxUE = 1:SimCtrl.N_UE
            SimCtrl.ml.dataset.ChEst_perUE{idxUE}.per_pdu = {};
            SimCtrl.ml.dataset.ChGenie_perUE{idxUE}.per_pdu = {};
        end
    end
return

% SimCtrl.ml.dataset.table_ML_datasets = py.pandas.DataFrame(pyargs('columns', py.dict(pyargs( ...
%               'timestamp',                  py.pandas.Series(pyargs('dtype','uint64')),...
%               'pduIdx',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'SFN',                        py.pandas.Series(pyargs('dtype','uint16')),...
%               'Slot',                       py.pandas.Series(pyargs('dtype','uint16')),...
%               'nPDUs',                      py.pandas.Series(pyargs('dtype','uint8')),...
%               'RachPresent',                py.pandas.Series(pyargs('dtype','uint8')),...
%               'nULSCH',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'nULCCH',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'nGroup',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'PDUSize',                    py.pandas.Series(pyargs('dtype','uint16')),...
%               'pduBitmap',                  py.pandas.Series(pyargs('dtype','uint16')),...
%               'RNTI',                       py.pandas.Series(pyargs('dtype','uint16')),...
%               'Handle',                     py.pandas.Series(pyargs('dtype','uint64')),...
%               'BWPSize',                    py.pandas.Series(pyargs('dtype','uint16')),...
%               'BWPStart',                   py.pandas.Series(pyargs('dtype','uint16')),...
%               'SubcarrierSpacing',          py.pandas.Series(pyargs('dtype','uint8')),...
%               'CyclicPrefix',               py.pandas.Series(pyargs('dtype','uint8')),...
%               'targetCodeRate',             py.pandas.Series(pyargs('dtype','uint16')),...
%               'qamModOrder',                py.pandas.Series(pyargs('dtype','uint8')),...
%               'mcsIndex',                   py.pandas.Series(pyargs('dtype','uint8')),...
%               'mcsTable',                   py.pandas.Series(pyargs('dtype','uint8')),...
%               'TransformPrecoding',         py.pandas.Series(pyargs('dtype','uint8')),...
%               'dataScramblingId',           py.pandas.Series(pyargs('dtype','uint8')),...
%               'nrOfLayers',                 py.pandas.Series(pyargs('dtype','uint8')),...
%               'dmrsConfigType',             py.pandas.Series(pyargs('dtype','uint8')),...
%               'ulDmrsScramblingId',         py.pandas.Series(pyargs('dtype','uint16')),...
%               'puschIdentity',              py.pandas.Series(pyargs('dtype','uint16')),...
%               'SCID',                       py.pandas.Series(pyargs('dtype','uint8')),...
%               'numDmrsCdmGrpsNoData',       py.pandas.Series(pyargs('dtype','uint8')),...
%               'dmrsPorts',                  py.pandas.Series(pyargs('dtype','uint16')),...
%               'resourceAlloc',              py.pandas.Series(pyargs('dtype','uint8')),...
%               'rbBitmap',                   py.pandas.Series(pyargs('dtype','uint8')),...
%               'rbStart',                    py.pandas.Series(pyargs('dtype','uint16')),...
%               'rbSize',                     py.pandas.Series(pyargs('dtype','uint16')),...
%               'VRBtoPRBMapping',            py.pandas.Series(pyargs('dtype','uint8')),...
%               'FrequencyHopping',           py.pandas.Series(pyargs('dtype','uint8')),...
%               'txDirectCurrentLocation',    py.pandas.Series(pyargs('dtype','uint8')),...
%               'uplinkFrequencyShift7p5khz', py.pandas.Series(pyargs('dtype','uint8')),...
%               'StartSymbolIndex',           py.pandas.Series(pyargs('dtype','uint8')),...
%               'NrOfSymbols',                py.pandas.Series(pyargs('dtype','uint8')),...
%               'nUE',                        py.pandas.Series(pyargs('dtype','uint8')),...
%               'idxUE',                      py.pandas.Series(pyargs('dtype','uint8')),...
%               'idxUeg',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'puschData',                  py.pandas.Series(pyargs('dtype','uint8')),... % Need to revisit
%               'puschUci',                   py.pandas.Series(pyargs('dtype','uint8')),...
%               'puschPtrs',                  py.pandas.Series(pyargs('dtype','uint8')),...
%               'dftsOfdm',                   py.pandas.Series(pyargs('dtype','uint8')),...
%               'Beamforming',                py.pandas.Series(pyargs('dtype','uint8')),...
%               'HarqID',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'PDULen',                     py.pandas.Series(pyargs('dtype','int64')),...
%               'UL_CQI',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'TimingAdvance',              py.pandas.Series(pyargs('dtype','uint16')),...
%               'RSSI',                       py.pandas.Series(pyargs('dtype','uint16')),...
%               'macPdu',                     py.pandas.Series(pyargs('dtype','uint8')),... % Need to revist
%               'TbCrcStatus',                py.pandas.Series(pyargs('dtype','uint8')),...
%               'NumCb',                      py.pandas.Series(pyargs('dtype','uint16')),...
%               'CbCrcStatus',                py.pandas.Series(pyargs('dtype','uint8')),...
%               'gt_coded_rm_bit_payload',    py.pandas.Series(pyargs('dtype','uint8')),...
%               'gt_data_symbols_i',          py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_data_symbols_q',          py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_Xtf_i',                   py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_Xtf_q',                   py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_Xtf_shape',               py.pandas.Series(pyargs('dtype','uint8')),...
%               'Ytf_i',                      py.pandas.Series(pyargs('dtype','float32')),...
%               'Ytf_q',                      py.pandas.Series(pyargs('dtype','float32')),...
%               'Ytf_shape',                  py.pandas.Series(pyargs('dtype','uint8')),...
%               'chan_est_i',                 py.pandas.Series(pyargs('dtype','float32')),...
%               'chan_est_q',                 py.pandas.Series(pyargs('dtype','float32')),...
%               'errInd',                     py.pandas.Series(pyargs('dtype','uint8')),...
%               'gt_info_bit_payload',        py.pandas.Series(pyargs('dtype','uint8')),...
%               'gt_channel_i',               py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_channel_q',               py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_channel_shape',           py.pandas.Series(pyargs('dtype','uint8')),...
%               'gt_time_offset',             py.pandas.Series(pyargs('dtype','float32')),...
%               'gt_freq_offset',             py.pandas.Series(pyargs('dtype','float32'))...
%               ))));

%         ColumnCfg = {'uint64',  'timestamp';... % nano sec
%                      'uint8',   'pduIdx';...
%                      'uint16',  'SFN';...
%                      'uint16',  'Slot';...
%                      'uint8',   'nPDUs';...
%                      'uint8',   'RachPresent';...
%                      'uint8',   'nULSCH';...
%                      'uint8',   'nULCCH';...
%                      'uint8',   'nGroup';...
%                      'uint16',  'PDUSize';...
%                      'uint16',  'pduBitmap';...
%                      'uint16',  'RNTI';...
%                      'uint64',  'Handle';...
%                      'uint16',  'BWPSize';...
%                      'uint16',  'BWPStart';...
%                      'uint8',   'SubcarrierSpacing';...
%                      'uint8',   'CyclicPrefix';...
%                      'uint16',  'targetCodeRate';...
%                      'uint8',   'qamModOrder';...
%                      'uint8',   'mcsIndex';...
%                      'uint8',   'mcsTable';...
%                      'uint8',   'TransformPrecoding';...
%                      'uint8',   'dataScramblingId';...
%                      'uint8',   'nrOfLayers';...
%                      'uint8',   'dmrsConfigType';...
%                      'uint16',  'ulDmrsScramblingId';...
%                      'uint16',  'puschIdentity';...
%                      'uint8',   'SCID';...
%                      'uint8',   'numDmrsCdmGrpsNoData';...
%                      'uint16',  'dmrsPorts';...
%                      'uint8',   'resourceAlloc';...
%                      'cellstr', 'rbBitmap';...
%                      'uint16',  'rbStart';...
%                      'uint16',  'rbSize';...
%                      'uint8',   'VRBtoPRBMapping';...
%                      'uint8',   'FrequencyHopping';...
%                      'uint8',   'txDirectCurrentLocation';...
%                      'uint8',   'uplinkFrequencyShift7p5khz';...
%                      'uint8',   'StartSymbolIndex';...
%                      'uint8',   'NrOfSymbols';...
%                      'uint8',   'nUE';...
%                      'uint8',   'idxUE';...
%                      'uint8',   'idxUeg';...
%                      'cellstr', 'puschData';... % Need to revisit
%                      'cellstr', 'puschUci';...
%                      'cellstr', 'puschPtrs';...
%                      'cellstr', 'dftsOfdm';...
%                      'cellstr', 'Beamforming';...
%                      'uint8',   'HarqID';...
%                      'int64',   'PDULen';...
%                      'uint8',   'UL_CQI';...
%                      'uint16',  'TimingAdvance';...
%                      'uint16',  'RSSI';...
%                      'cellstr', 'macPdu';...
%                      'uint8',   'TbCrcStatus';...
%                      'uint16',  'NumCb';...
%                      'cellstr', 'CbCrcStatus';...
%                      'cellstr', 'gt_coded_rm_bit_payload';... cellstr(num2str())
%                      'cellstr', 'gt_data_symbols_i';...
%                      'cellstr', 'gt_data_symbols_q';...
%                      'cellstr', 'gt_Xtf_i';...
%                      'cellstr', 'gt_Xtf_q';...
%                      'cellstr', 'gt_Xtf_shape';...
%                      'cellstr', 'Ytf_i';...
%                      'cellstr', 'Ytf_q';...
%                      'cellstr', 'Ytf_shape';...
%                      'cellstr', 'chan_est_i';...
%                      'cellstr', 'chan_est_q';...
%                      'cellstr', 'errInd';...
%                      'cellstr', 'gt_info_bit_payload';...
%                      'cellstr', 'gt_channel_i';...
%                      'cellstr', 'gt_channel_q';...
%                      'cellstr', 'gt_channel_shape';...
%                      'double',  'gt_time_offset';...
%                      'double',  'gt_freq_offset';
%                      };
%         num_variables = size(ColumnCfg, 1);
%         SimCtrl.ml.dataset.table_ML_datasets = table('Size', [0, num_variables], 'VariableTypes', ColumnCfg(:,1),'VariableNames', ColumnCfg(:,2));
%         SimCtrl.ml.dataset.ColumnCfg = ColumnCfg;
%         parquetwrite('/home/Aerial/tmp/my_test.parquet',table_ML_datasets)